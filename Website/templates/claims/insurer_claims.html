{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Claim</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background: #f1f5f9; font-family: 'Plus Jakarta Sans', sans-serif; padding: 40px; display: flex; justify-content: center; }
        .workspace { display: grid; grid-template-columns: 320px 1fr; gap: 40px; max-width: 1200px; width: 100%; }

        /* Sticky Sidebar */
        .sidebar-card { background: white; border-radius: 20px; padding: 30px; height: fit-content; box-shadow: 0 10px 30px rgba(0,0,0,0.03); position: sticky; top: 40px; border: 1px solid #e2e8f0; }
        .label { font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-bottom: 5px; }
        .val { font-size: 15px; font-weight: 600; color: #334155; margin-bottom: 20px; border-bottom: 1px solid #f9f9f9; padding-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; margin-bottom: 10px; transition: 0.2s; }
        .approve { background: #10b981; color: white; }
        .approve:hover { background: #059669; }
        .reject { background: #ef4444; color: white; }
        .reject:hover { background: #dc2626; }

        .main-panel { background: white; border-radius: 24px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .abstract-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 25px; border-radius: 16px; font-family: monospace; color: #334155; line-height: 1.6; }

        /* AI Section Styles */
        .ai-card {
            background: linear-gradient(135deg, #fdfbf7 0%, #fff 100%);
            border: 1px solid #fcd34d; border-radius: 16px; padding: 25px; margin-bottom: 30px;
            position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.05);
        }
        .ai-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #f59e0b;
        }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .ai-title { font-weight: 700; color: #b45309; display: flex; align-items: center; gap: 8px; }
        .ai-content { font-size: 14px; color: #4b5563; line-height: 1.6; white-space: pre-line; }
        .btn-ai {
            background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn-ai:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }

        /* Evidence Image Grid */
        .evidence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .img-container {
            height: 250px; background: #f1f5f9; border-radius: 16px; border: 1px solid #e2e8f0;
            overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;
            color: #cbd5e1; font-size: 30px;
        }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: zoom-in; }
        .img-container:hover img { transform: scale(1.05); }
        .img-tag {
            position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); color: white;
            padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; z-index: 2;
        }

    </style>
</head>
<body>
    <div class="workspace">
        <div class="sidebar-card">
            <h3 style="color: #4e37b5; margin-top:0;">Claim Review</h3>
            <div class="label">Date</div><div class="val" id="cDate">Loading...</div>
            <div class="label">Location</div><div class="val" id="cLoc">---</div>
            <div class="label">Cause</div><div class="val" id="cCause">---</div>

            <div style="margin-top: 30px;">
                <button class="btn approve" onclick="updateStatus('Approved')"><i class="bi bi-check-lg"></i> Approve Claim</button>
                <button class="btn reject" onclick="updateStatus('Rejected')"><i class="bi bi-x-lg"></i> Reject Claim</button>
            </div>
            <a href="{% url 'insurer_dashboard' %}" style="display:block; text-align:center; margin-top:20px; text-decoration:none; color:#94a3b8; font-size:13px;">Back to Dashboard</a>
        </div>

        <div class="main-panel">
            <!-- AI Analysis Section -->
            <div class="ai-card">
                <div class="ai-header">
                    <div class="ai-title"><i class="bi bi-stars"></i> AI Risk Assessment</div>
                    <button class="btn-ai" onclick="analyzeClaim()" id="btnAnalyze">Generate Analysis</button>
                </div>
                <div id="aiResult" class="ai-content">
                    Click "Generate Analysis" to have Gemini AI review the incident details for potential inconsistencies or fraud markers.
                </div>
            </div>

            <h2 style="color: #1e293b; font-size: 18px; margin-bottom: 15px;">Incident Details</h2>
            <div class="abstract-box" id="cDetails">Loading OB Details...</div>

            <h3 style="margin-top: 40px; color: #1e293b; font-size: 18px;">Photographic Evidence</h3>
            <div class="evidence-grid">
                <div class="img-container">
                    <div class="img-tag">Client Vehicle</div>
                    <img id="imgMyCar" alt="No Image">
                </div>
                <div class="img-container">
                    <div class="img-tag">Third Party / Scene</div>
                    <img id="imgOtherCar" alt="No Image">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, update, limitToLast, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfZ4L9Qf--qXVt6fSTovL6NufC-UEUHv8",
            authDomain: "bimadrive-46fd0.firebaseapp.com",
            databaseURL: "https://bimadrive-46fd0-default-rtdb.firebaseio.com",
            projectId: "bimadrive-46fd0",
            storageBucket: "bimadrive-46fd0.firebasestorage.app",
            messagingSenderId: "672547346096",
            appId: "1:672547346096:android:116a85b7da6254b5b88d75"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentClaimId = null;
        let claimData = {};

        async function loadClaim() {
            // Check localStorage first
            const storedId = localStorage.getItem('currentClaimId');

            let q;
            if (storedId) {
                q = ref(db, `accidentReports/${storedId}`);
            } else {
                 q = query(ref(db, 'accidentReports'), limitToLast(1));
            }

            try {
                const snapshot = await get(q);
                if (snapshot.exists()) {
                    const val = snapshot.val();

                    // Handle single record vs collection response
                    if (storedId) {
                        claimData = val;
                        currentClaimId = storedId;
                    } else {
                        // If fetching limitToLast(1), it returns an object with a key
                        const keys = Object.keys(val);
                        currentClaimId = keys[0];
                        claimData = val[currentClaimId];
                    }

                    // Populate Text Data
                    document.getElementById('cDate').innerText = new Date(claimData.timestamp).toLocaleDateString();
                    document.getElementById('cLoc').innerText = claimData.location || '---';
                    document.getElementById('cCause').innerText = claimData.cause || '---';
                    document.getElementById('cDetails').innerHTML = `<strong>OB NUMBER:</strong> ${claimData.obNumber || 'N/A'}<br><strong>STATUS:</strong> ${claimData.status || 'Pending'}<br><br><strong>NOTES:</strong> Reported via client app at ${new Date(claimData.timestamp).toLocaleTimeString()}`;

                    // Populate Images
                    if (claimData.myCarImg) {
                        document.getElementById('imgMyCar').src = claimData.myCarImg;
                    } else {
                         // Optional: Set a placeholder if empty
                         document.getElementById('imgMyCar').parentElement.innerHTML = '<span style="color:#cbd5e1; font-size:14px;">No Image Uploaded</span>';
                    }

                    if (claimData.otherCarImg) {
                        document.getElementById('imgOtherCar').src = claimData.otherCarImg;
                    } else {
                         document.getElementById('imgOtherCar').parentElement.innerHTML = '<span style="color:#cbd5e1; font-size:14px;">No Third Party Image</span>';
                    }
                } else {
                    alert("Claim not found.");
                    window.location.href = "{% url 'insurer_dashboard' %}";
                }
            } catch (e) {
                console.error("Error loading claim:", e);
                alert("Error loading data.");
            }
        }

        window.updateStatus = async (status) => {
            if (!currentClaimId) return;
            if(confirm(`Mark this claim as ${status}?`)) {
                await update(ref(db, `accidentReports/${currentClaimId}`), { status: status });
                alert(`Claim marked as ${status}`);
                window.location.href = "{% url 'insurer_dashboard' %}";
            }
        };

        // --- GEMINI AI INTEGRATION ---
        window.analyzeClaim = async () => {
            if (!claimData.location) return;

            const btn = document.getElementById('btnAnalyze');
            const output = document.getElementById('aiResult');

            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';
            btn.disabled = true;
            output.innerText = "Processing claim data...";

            const apiKey = ""; // System injected key
            const prompt = `Act as an insurance fraud analyst. Analyze this car accident claim for risk:
            - Cause: ${claimData.cause}
            - Location: ${claimData.location}
            - Time: ${claimData.time}
            - OB Number: ${claimData.obNumber}

            Provide a short assessment in this format:
            **Risk Level:** [Low/Medium/High]
            **Reasoning:** [1 sentence]
            **Recommendation:** [Approve/Investigate]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                     const text = data.candidates[0].content.parts[0].text;
                     output.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                } else {
                    output.innerText = "AI analysis inconclusive.";
                }

            } catch (error) {
                console.error(error);
                output.innerText = "AI Analysis failed. Please try again.";
            } finally {
                btn.innerHTML = 'Generate Analysis';
                btn.disabled = false;
            }
        };

        loadClaim();
    </script>
</body>
</html>