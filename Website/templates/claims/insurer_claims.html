{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Claim Case</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #0ea5e9;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background: #f1f5f9; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0;
            display: flex; min-height: 100vh; overflow-x: hidden;
            background-image:
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0.03) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0.03) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0.03) 0, transparent 50%);
            background-attachment: fixed;
        }

        /* --- Sidebar (Collapsed style for focus) --- */
        .sidebar {
            width: 80px; background: #ffffff; border-right: 1px solid #e2e8f0;
            padding: 30px 0; position: fixed; height: 100vh; display: flex; flex-direction: column;
            align-items: center; z-index: 100;
        }
        .logo i { font-size: 28px; color: var(--primary); margin-bottom: 40px; }
        .menu-icon {
            font-size: 20px; color: #94a3b8; padding: 15px; border-radius: 12px;
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .menu-icon:hover { background: #f1f5f9; color: var(--dark); }
        .menu-icon.active { background: var(--primary); color: white; }

        .back-home { margin-top: auto; color: #64748b; font-size: 24px; cursor: pointer; }

        /* --- Main Content --- */
        .main-content {
            margin-left: 80px; flex: 1; padding: 40px 60px; max-width: 1600px; margin-right: auto;
        }

        .top-bar { margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; }
        .breadcrumb { font-size: 13px; color: #64748b; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .breadcrumb a { text-decoration: none; color: #64748b; font-weight: 600; }
        .breadcrumb i { font-size: 10px; }

        h1 { font-size: 28px; font-weight: 800; color: var(--dark); margin: 0; letter-spacing: -0.5px; }

        .status-badge {
            padding: 8px 20px; border-radius: 30px; font-size: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .st-pending { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
        .st-approved { background: #ecfdf5; color: #059669; border: 1px solid #d1fae5; }
        .st-rejected { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }

        /* Grid Layout */
        .case-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }

        .panel {
            background: var(--glass-bg); border-radius: 24px; padding: 35px;
            border: var(--glass-border); box-shadow: var(--shadow-sm);
        }

        h3 { font-size: 16px; font-weight: 700; color: var(--dark); margin: 0 0 25px 0; display: flex; align-items: center; gap: 10px; }
        h3 i { color: var(--primary); font-size: 18px; }

        /* Info Grid */
        .info-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-item label { display: block; font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px; }
        .info-item div { font-size: 15px; font-weight: 600; color: #334155; padding: 12px 15px; background: white; border-radius: 10px; border: 1px solid #e2e8f0; }

        /* Abstract Box */
        .abstract-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 25px;
            font-family: 'Courier New', monospace; font-size: 13px; color: #475569; line-height: 1.6;
        }
        .highlight { background: #fef3c7; padding: 2px 6px; border-radius: 4px; color: #92400e; font-weight: 700; }

        /* Evidence */
        .evidence-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .img-container {
            height: 220px; background: white; border-radius: 16px; border: 1px solid #e2e8f0;
            overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;
            color: #cbd5e1; font-size: 30px;
        }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: pointer; }
        .img-container:hover img { transform: scale(1.05); }
        .img-tag {
            position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); color: white;
            padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 600;
        }

        /* Actions Panel */
        .action-panel { background: white; border-top: 4px solid var(--primary); }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn {
            flex: 1; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 14px;
            border: none; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-approve { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }
        .btn-approve:hover { background: #059669; transform: translateY(-2px); }

        .btn-reject { background: white; border: 2px solid var(--danger); color: var(--danger); }
        .btn-reject:hover { background: #fef2f2; }

    </style>
</head>
<body>

    <div class="sidebar">
        <a href="#" class="logo"><i class="bi bi-shield-check-fill"></i></a>
        <div class="menu-icon" onclick="goBack()"><i class="bi bi-grid-fill"></i></div>
        <div class="menu-icon active"><i class="bi bi-file-earmark-text"></i></div>
        <div class="menu-icon"><i class="bi bi-gear"></i></div>
        <i class="bi bi-box-arrow-left back-home" onclick="goBack()"></i>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div>
                <div class="breadcrumb">
                    <a href="#" onclick="goBack()">Dashboard</a> <i class="bi bi-chevron-right"></i> <span>Case Review</span>
                </div>
                <h1 id="pageTitle">Reviewing Claim...</h1>
            </div>
            <div id="statusBadge" class="status-badge st-pending">Pending</div>
        </div>

        <div class="case-grid">
            <!-- Left Column: Details -->
            <div class="details-column">
                <div class="panel" style="margin-bottom: 30px;">
                    <h3><i class="bi bi-info-circle"></i> Incident Information</h3>
                    <div class="info-row">
                        <div class="info-item">
                            <label>Date & Time</label>
                            <div id="cDate">---</div>
                        </div>
                        <div class="info-item">
                            <label>Location</label>
                            <div id="cLoc">---</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-item">
                            <label>Reported Cause</label>
                            <div id="cCause">---</div>
                        </div>
                        <div class="info-item">
                            <label>Client ID</label>
                            <div id="cUser" style="font-family: monospace;">---</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3><i class="bi bi-file-text"></i> Official Police Abstract</h3>
                    <div class="abstract-box" id="cAbstract">
                        Loading abstract details...
                    </div>
                </div>
            </div>

            <!-- Right Column: Evidence & Action -->
            <div class="media-column">
                <div class="panel" style="margin-bottom: 30px;">
                    <h3><i class="bi bi-images"></i> Photographic Evidence</h3>
                    <div class="evidence-grid">
                        <div class="img-container">
                            <div class="img-tag">Client Vehicle</div>
                            <img id="imgMyCar" alt="No Image">
                        </div>
                        <div class="img-container">
                            <div class="img-tag">Third Party / Scene</div>
                            <img id="imgOtherCar" alt="No Image">
                        </div>
                    </div>
                </div>

                <div class="panel action-panel">
                    <h3><i class="bi bi-gavel"></i> Assessor Decision</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 0;">Please review all evidence and abstract details before making a final decision on this claim.</p>

                    <div class="btn-group">
                        <button class="btn btn-approve" onclick="updateStatus('Approved')">
                            <i class="bi bi-check-lg"></i> Approve Claim
                        </button>
                        <button class="btn btn-reject" onclick="updateStatus('Rejected')">
                            <i class="bi bi-x-lg"></i> Reject Claim
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfZ4L9Qf--qXVt6fSTovL6NufC-UEUHv8",
            authDomain: "bimadrive-46fd0.firebaseapp.com",
            databaseURL: "https://bimadrive-46fd0-default-rtdb.firebaseio.com",
            projectId: "bimadrive-46fd0",
            storageBucket: "bimadrive-46fd0.firebasestorage.app",
            messagingSenderId: "672547346096",
            appId: "1:672547346096:android:116a85b7da6254b5b88d75"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Get specific ID from localStorage set by Dashboard
        const currentClaimId = localStorage.getItem('currentClaimId');

        async function loadClaim() {
            if (!currentClaimId) {
                alert("No claim selected. Redirecting to dashboard.");
                window.location.href = "{% url 'insurer_dashboard' %}";
                return;
            }

            try {
                const snapshot = await get(ref(db, `accidentReports/${currentClaimId}`));
                if (snapshot.exists()) {
                    const claim = snapshot.val();

                    // Header
                    document.getElementById('pageTitle').innerText = `Claim #${currentClaimId.substring(1, 8).toUpperCase()}`;

                    // Status Badge
                    const badge = document.getElementById('statusBadge');
                    badge.innerText = claim.status || 'Pending';
                    badge.className = 'status-badge'; // Reset
                    if (claim.status === 'Approved') badge.classList.add('st-approved');
                    else if (claim.status === 'Rejected') badge.classList.add('st-rejected');
                    else badge.classList.add('st-pending');

                    // Details
                    document.getElementById('cDate').innerText = new Date(claim.timestamp).toLocaleString();
                    document.getElementById('cLoc').innerText = claim.location || '---';
                    document.getElementById('cCause').innerText = claim.cause || '---';
                    document.getElementById('cUser').innerText = claim.userId || '---';

                    // Abstract
                    document.getElementById('cAbstract').innerHTML = `
                        <strong>OB NUMBER:</strong> <span class="highlight">${claim.obNumber}</span><br><br>
                        <strong>REPORT TYPE:</strong> VEHICLE ACCIDENT<br>
                        <strong>SEVERITY:</strong> MAJOR DAMAGE REPORTED<br>
                        <strong>NOTES:</strong> Incident logged via BimaDrive Client App. Location metadata verified.
                    `;

                    // Images
                    if(claim.myCarImg) document.getElementById('imgMyCar').src = claim.myCarImg;
                    if(claim.otherCarImg) document.getElementById('imgOtherCar').src = claim.otherCarImg;

                } else {
                    alert("Claim not found.");
                    window.location.href = "{% url 'insurer_dashboard' %}";
                }
            } catch (error) {
                console.error(error);
                alert("Error loading claim data.");
            }
        }

        window.updateStatus = async (status) => {
            if (!currentClaimId) return;

            if(confirm(`Are you sure you want to mark this claim as ${status}?`)) {
                try {
                    await update(ref(db, `accidentReports/${currentClaimId}`), { status: status });
                    alert(`Claim ${status} Successfully`);
                    window.location.href = "{% url 'insurer_dashboard' %}";
                } catch (error) {
                    console.error(error);
                    alert("Update failed: " + error.message);
                }
            }
        };

        window.goBack = () => {
            window.location.href = "{% url 'insurer_dashboard' %}";
        }

        loadClaim();
    </script>
</body>
</html>