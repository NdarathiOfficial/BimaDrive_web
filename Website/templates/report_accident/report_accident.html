{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Report Incident</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --brand-gradient: linear-gradient(135deg, #4e37b5 0%, #46bbf4 100%);
            --alert-color: #ff6b6b;
            --bg-input: #f8fafc;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            background: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex; justify-content: center; padding: 60px 20px;
            /* Mesh Background */
            background-image:
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0.05) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0.05) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0.05) 0, transparent 50%);
            background-size: cover; background-attachment: fixed;
            min-height: 100vh;
        }

        .container {
            width: 950px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(24px);
            border-radius: 24px; box-shadow: 0 30px 60px rgba(0,0,0,0.1);
            overflow: hidden; border: 1px solid rgba(255,255,255,0.5);
        }

        .header-strip {
            background: var(--brand-gradient); padding: 50px 60px; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-strip h1 { font-size: 32px; font-weight: 700; margin: 0; }
        .header-strip p { margin: 8px 0 0; opacity: 0.9; font-size: 15px; }
        .icon-alert { font-size: 48px; opacity: 0.5; }

        .form-body { padding: 60px; }

        .section-label {
            font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
            color: #94a3b8; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 15px;
        }
        .section-label::after { content: ''; height: 1px; flex: 1; background: #e2e8f0; }

        /* Incident Selector Cards */
        .cause-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 25px; margin-bottom: 50px;
        }
        .cause-option {
            border: 2px solid #e2e8f0; border-radius: 16px; padding: 25px 15px;
            text-align: center; cursor: pointer; transition: 0.3s; background: white;
        }
        .cause-option:hover { border-color: #4e37b5; background: #f8faff; }
        .cause-option input { display: none; }
        .cause-option.selected { border-color: #4e37b5; background: #eff6ff; box-shadow: 0 10px 20px rgba(78, 55, 181, 0.1); }

        .c-icon { font-size: 28px; color: #64748b; margin-bottom: 12px; display: block; }
        .cause-option.selected .c-icon { color: #4e37b5; }
        .c-text { font-size: 14px; font-weight: 600; color: #334155; }

        /* Inputs */
        .input-row {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 40px; margin-bottom: 35px;
        }

        .field-group label {
            display: block; font-size: 13px; font-weight: 700;
            color: #1e293b; margin-bottom: 12px;
        }
        .field-group input, .field-group select {
            width: 100%; padding: 16px; border: 1px solid #e2e8f0; border-radius: 12px;
            background: #f8fafc; font-size: 15px; transition: 0.3s; font-weight: 500; color: #334155;
        }
        .field-group input:focus { background: white; border-color: #46bbf4; outline: none; box-shadow: 0 0 0 4px rgba(70, 187, 244, 0.1); }

        /* Uploads */
        .upload-row {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .upload-box {
            border: 2px dashed #cbd5e1; border-radius: 16px; padding: 40px; text-align: center;
            cursor: pointer; transition: 0.3s; background: white; position: relative; overflow: hidden; height: 220px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .upload-box:hover { border-color: #ff6b6b; background: #fffbfb; }
        .u-title { font-weight: 700; color: #334155; margin-bottom: 8px; display: block; font-size: 16px; }
        .u-desc { font-size: 13px; color: #94a3b8; }

        .preview-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; display: none; z-index: 2;
        }
        .content-layer { z-index: 1; transition: 0.3s; }

        .btn-submit {
            width: 100%; padding: 22px; background: #1e293b; color: white; border: none;
            border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 50px;
            cursor: pointer; transition: 0.3s;
        }
        .btn-submit:hover { background: var(--alert-color); box-shadow: 0 15px 30px rgba(255, 107, 107, 0.25); transform: translateY(-2px); }
        .btn-submit:disabled { opacity: 0.7; cursor: wait; transform: none; }

    </style>
</head>
<body>

<form id="accidentForm">
    <div class="container">
        <div class="header-strip">
            <div>
                <h1>Incident Report</h1>
                <p>Submit details for immediate claims processing.</p>
            </div>
            <i class="bi bi-exclamation-triangle-fill icon-alert"></i>
        </div>

        <div class="form-body">
            <div class="section-label">1. Cause of Incident</div>
            <div class="cause-grid">
                <label class="cause-option" onclick="selectCause(this)">
                    <i class="bi bi-car-front-fill c-icon"></i>
                    <span class="c-text">Collision</span>
                    <input type="radio" name="cause" value="Collision" required>
                </label>
                <label class="cause-option" onclick="selectCause(this)">
                    <i class="bi bi-fire c-icon"></i>
                    <span class="c-text">Fire</span>
                    <input type="radio" name="cause" value="Fire">
                </label>
                <label class="cause-option" onclick="selectCause(this)">
                    <i class="bi bi-person-x-fill c-icon"></i>
                    <span class="c-text">Theft</span>
                    <input type="radio" name="cause" value="Theft">
                </label>
                <label class="cause-option" onclick="selectCause(this)">
                    <i class="bi bi-tools c-icon"></i>
                    <span class="c-text">Vandalism</span>
                    <input type="radio" name="cause" value="Other">
                </label>
            </div>

            <div class="section-label">2. Incident Details</div>
            <div class="input-row">
                <div class="field-group">
                    <label>Date of Incident</label>
                    <input type="date" id="date" required>
                </div>
                <div class="field-group">
                    <label>Approx. Time</label>
                    <input type="time" id="time" required>
                </div>
            </div>
            <div class="input-row">
                <div class="field-group">
                    <label>Location</label>
                    <input type="text" id="location" placeholder="e.g. Mombasa Road near JKIA" required>
                </div>
                <div class="field-group">
                    <label>Police OB Number</label>
                    <input type="text" id="ob_number" placeholder="Enter Abstract No." required>
                </div>
            </div>

            <div class="section-label">3. Evidence Upload</div>
            <div class="upload-row">
                <div class="upload-box" onclick="document.getElementById('myCar').click()">
                    <div class="content-layer">
                        <i class="bi bi-camera-fill" style="font-size: 32px; color: #cbd5e1; margin-bottom: 15px; display:block;"></i>
                        <span class="u-title">Your Vehicle</span>
                        <span class="u-desc">Upload visible damage</span>
                    </div>
                    <img id="prevMyCar" class="preview-layer">
                    <input type="file" id="myCar" name="my_car_img" style="display: none;" required onchange="preview(this, 'prevMyCar')">
                </div>
                <div class="upload-box" onclick="document.getElementById('otherCar').click()">
                    <div class="content-layer">
                        <i class="bi bi-image" style="font-size: 32px; color: #cbd5e1; margin-bottom: 15px; display:block;"></i>
                        <span class="u-title">Third Party</span>
                        <span class="u-desc">Other vehicle or scene</span>
                    </div>
                    <img id="prevOtherCar" class="preview-layer">
                    <input type="file" id="otherCar" name="other_car_img" style="display: none;" onchange="preview(this, 'prevOtherCar')">
                </div>
            </div>

            <button type="submit" class="btn-submit">Submit Claim Report</button>
        </div>
    </div>
</form>

<script>
    function selectCause(element) {
        document.querySelectorAll('.cause-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
    }

    function preview(input, imgId) {
        if (input.files && input.files[0]) {
            const img = document.getElementById(imgId);
            img.src = URL.createObjectURL(input.files[0]);
            img.style.display = 'block';
            // Hide content layer
            img.previousElementSibling.style.opacity = '0';
        }
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCfZ4L9Qf--qXVt6fSTovL6NufC-UEUHv8",
        authDomain: "bimadrive-46fd0.firebaseapp.com",
        databaseURL: "https://bimadrive-46fd0-default-rtdb.firebaseio.com",
        projectId: "bimadrive-46fd0",
        storageBucket: "bimadrive-46fd0.firebasestorage.app",
        messagingSenderId: "672547346096",
        appId: "1:672547346096:android:116a85b7da6254b5b88d75"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- CLOUDINARY UPLOAD ---
    async function uploadToCloudinary(file) {
        const cloudName = "drx3tzhrk";
        const uploadPreset = "app_images";

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
            method: 'POST',
            body: formData
        });

        if (!res.ok) throw new Error("Image upload failed");
        const data = await res.json();
        return data.secure_url;
    }

    document.getElementById('accidentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) { alert('Please login first'); return; }

        const btn = document.querySelector('.btn-submit');
        btn.innerText = "Uploading Evidence...";
        btn.disabled = true;

        try {
            const myCarFile = document.getElementById('myCar').files[0];
            const otherCarFile = document.getElementById('otherCar').files[0];

            // Determine selected cause
            const causeEl = document.querySelector('input[name="cause"]:checked');
            const cause = causeEl ? causeEl.value : 'Other';

            // Parallel Uploads
            const uploadPromises = [];
            let myCarUrl = "";
            let otherCarUrl = "";

            if (myCarFile) {
                uploadPromises.push(uploadToCloudinary(myCarFile).then(url => myCarUrl = url));
            }
            if (otherCarFile) {
                uploadPromises.push(uploadToCloudinary(otherCarFile).then(url => otherCarUrl = url));
            }

            await Promise.all(uploadPromises);

            const data = {
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                location: document.getElementById('location').value,
                obNumber: document.getElementById('ob_number').value,
                cause: cause,
                userId: user.uid,
                myCarImg: myCarUrl,
                otherCarImg: otherCarUrl,
                status: 'In Review',
                timestamp: new Date().toISOString()
            };

            const newRef = push(ref(db, 'accidentReports'));
            await set(newRef, data);

            alert('Report Submitted Successfully! Insurer notified.');
            window.location.href = "{% url 'client_dashboard' %}";
        } catch (error) {
            console.error(error);
            alert('Error: ' + error.message);
            btn.innerText = "Submit Claim Report";
            btn.disabled = false;
        }
    });
</script>

</body>
</html>