{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Vehicle</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --brand-gradient: linear-gradient(135deg, #4e37b5 0%, #46bbf4 100%);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --bg-input: #f8fafc;
        }

        body {
            margin: 0; font-family: 'Poppins', sans-serif;
            background: #f1f5f9; display: flex; justify-content: center; align-items: center; min-height: 100vh;
            padding: 40px;
        }

        .main-card {
            width: 1100px; height: 800px; background: white;
            border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            display: flex; overflow: hidden; position: relative;
        }

        /* Left Visual Side */
        .visual-side {
            width: 35%; background: var(--brand-gradient);
            padding: 60px; color: white; display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden;
        }

        .visual-side::before {
            content: ''; position: absolute; width: 300px; height: 300px;
            background: rgba(255,255,255,0.1); border-radius: 50%; top: -50px; left: -50px;
        }
        .visual-side::after {
            content: ''; position: absolute; width: 400px; height: 400px;
            background: rgba(255,255,255,0.05); border-radius: 50%; bottom: -100px; right: -100px;
        }

        .visual-content { position: relative; z-index: 2; }
        h1 { font-size: 42px; font-weight: 700; line-height: 1.1; margin-bottom: 20px; }
        p.tagline { font-size: 16px; opacity: 0.9; line-height: 1.6; font-weight: 300; }

        .feature-list { margin-top: 40px; }
        .feature { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; font-size: 15px; }
        .icon-circle {
            width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }

        /* Right Form Side */
        .form-side {
            width: 65%; padding: 60px 80px; overflow-y: auto; position: relative;
        }

        .form-header { margin-bottom: 40px; }
        h2 { font-size: 28px; color: var(--text-main); margin-bottom: 10px; font-weight: 700; }
        p.sub-head { color: var(--text-sub); font-size: 15px; }

        .input-group { margin-bottom: 30px; }
        label {
            display: block; font-size: 13px; font-weight: 700;
            color: var(--text-main); margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        input {
            width: 100%; padding: 18px 24px; background: var(--bg-input);
            border: 2px solid transparent; border-radius: 14px; font-size: 15px; color: var(--text-main);
            transition: 0.3s; font-weight: 500;
        }
        input:focus { background: white; border-color: #4e37b5; outline: none; box-shadow: 0 4px 20px rgba(78, 55, 181, 0.1); }

        .row-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        /* Image Update Section */
        .image-update-zone {
            margin-top: 20px;
            border: 2px dashed #cbd5e1; border-radius: 16px; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; background: #f8fafc; position: relative; height: 220px; overflow: hidden;
        }
        .image-update-zone:hover { border-color: #46bbf4; background: #f0f9ff; }

        #currentPhoto {
            width: 100%; height: 100%; object-fit: cover; border-radius: 12px; position: absolute; top: 0; left: 0;
        }

        .overlay-label {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7);
            color: white; padding: 15px; text-align: center; font-size: 14px; font-weight: 600;
            transform: translateY(100%); transition: 0.3s; backdrop-filter: blur(5px);
        }
        .image-update-zone:hover .overlay-label { transform: translateY(0); }

        .btn-submit {
            width: 100%; padding: 20px; background: var(--text-main); color: white;
            border: none; border-radius: 14px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: 0.3s; margin-top: 30px;
        }
        .btn-submit:hover { background: #4e37b5; transform: translateY(-2px); box-shadow: 0 15px 30px rgba(78, 55, 181, 0.2); }

        .back-btn {
            position: absolute; top: 40px; right: 40px; text-decoration: none;
            color: var(--text-sub); font-weight: 600; font-size: 14px; transition: 0.2s;
            background: #f1f5f9; padding: 8px 20px; border-radius: 20px;
        }
        .back-btn:hover { color: white; background: #4e37b5; }

    </style>
</head>
<body>

    <div class="main-card">
        <!-- Visual Side -->
        <div class="visual-side">
            <div class="visual-content">
                <h1>Update<br>Vehicle</h1>
                <p class="tagline">Keep your vehicle information up to date to ensure accurate valuation and insurance coverage.</p>

                <div class="feature-list">
                    <div class="feature">
                        <div class="icon-circle"><i class="bi bi-pencil-square"></i></div>
                        <span>Modify Details Instantly</span>
                    </div>
                    <div class="feature">
                        <div class="icon-circle"><i class="bi bi-camera-fill"></i></div>
                        <span>Update Vehicle Photo</span>
                    </div>
                    <div class="feature">
                        <div class="icon-circle"><i class="bi bi-arrow-repeat"></i></div>
                        <span>Re-Sync Valuation Data</span>
                    </div>
                </div>
            </div>
            <div style="font-size: 12px; opacity: 0.6;">BimaDrive Secure Systems Â© 2025</div>
        </div>

        <!-- Form Side -->
        <div class="form-side">
            <a href="{% url 'view_vehicle' %}" class="back-btn">Cancel</a>

            <div class="form-header">
                <h2>Modify Details</h2>
                <p class="sub-head">Edit the fields below to update your car profile.</p>
            </div>

            <form id="updateForm">
                <!-- Image Update Field -->
                <div class="input-group">
                    <label>Vehicle Photo</label>
                    <div class="image-update-zone" onclick="document.getElementById('vPhoto').click()">
                        <img id="currentPhoto" src="" alt="Vehicle Photo">
                        <div class="overlay-label"><i class="bi bi-camera-fill"></i> Tap to Change Photo</div>
                        <input type="file" id="vPhoto" accept="image/*" style="display: none;" onchange="previewFile()">
                    </div>
                </div>

                <div class="input-group">
                    <label>Owner Name</label>
                    <input type="text" id="owner_name" required>
                </div>

                <div class="row-grid">
                    <div class="input-group">
                        <label>Registration</label>
                        <input type="text" id="reg_plate" required>
                    </div>
                    <div class="input-group">
                        <label>Model</label>
                        <input type="text" id="model" required>
                    </div>
                </div>

                <div class="row-grid">
                    <div class="input-group">
                        <label>Chassis Number</label>
                        <input type="text" id="chassis_no" required>
                    </div>
                    <div class="input-group">
                        <label>Color</label>
                        <input type="text" id="color" required>
                    </div>
                </div>

                <button type="submit" class="btn-submit">Save Changes</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, query, orderByChild, equalTo, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfZ4L9Qf--qXVt6fSTovL6NufC-UEUHv8",
            authDomain: "bimadrive-46fd0.firebaseapp.com",
            databaseURL: "https://bimadrive-46fd0-default-rtdb.firebaseio.com",
            projectId: "bimadrive-46fd0",
            storageBucket: "bimadrive-46fd0.firebasestorage.app",
            messagingSenderId: "672547346096",
            appId: "1:672547346096:android:116a85b7da6254b5b88d75"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentVehicleKey = null;

        // 1. Fetch Existing Data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const vRef = ref(db, 'Vehicles');

                try {
                    // Manual filter to match vehicle_details logic
                    const snapshot = await get(vRef);
                    if (snapshot.exists()) {
                        const allVehicles = snapshot.val();
                        let foundVehicle = null;

                        for (const key in allVehicles) {
                            if (allVehicles[key].ownerId === user.uid) {
                                foundVehicle = allVehicles[key];
                                currentVehicleKey = key;
                                break;
                            }
                        }

                        if (foundVehicle) {
                            // Populate fields
                            document.getElementById('owner_name').value = foundVehicle.ownerName;
                            document.getElementById('reg_plate').value = foundVehicle.regPlate;
                            document.getElementById('model').value = foundVehicle.model;
                            document.getElementById('chassis_no').value = foundVehicle.chassisNo;
                            document.getElementById('color').value = foundVehicle.color;

                            // Populate Image
                            if (foundVehicle.photo) {
                                document.getElementById('currentPhoto').src = foundVehicle.photo;
                            } else {
                                document.getElementById('currentPhoto').src = "https://via.placeholder.com/800x400?text=No+Image";
                            }
                        } else {
                            alert("No vehicle found to update.");
                            window.location.href = "{% url 'add_vehicle' %}";
                        }
                    } else {
                        alert("No vehicle data available.");
                        window.location.href = "{% url 'add_vehicle' %}";
                    }
                } catch (error) {
                    console.error("Error fetching vehicle:", error);
                }
            } else {
                window.location.href = "{% url 'login' %}";
            }
        });

        // 2. Helper to convert image
        const convertBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        // 3. Handle Update
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentVehicleKey) return;

            const btn = document.querySelector('.btn-submit');
            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                let updatedData = {
                    ownerName: document.getElementById('owner_name').value,
                    regPlate: document.getElementById('reg_plate').value,
                    model: document.getElementById('model').value,
                    chassisNo: document.getElementById('chassis_no').value,
                    color: document.getElementById('color').value
                };

                // Check if a new photo was selected
                const fileInput = document.getElementById('vPhoto');
                if (fileInput.files.length > 0) {
                    const newPhotoBase64 = await convertBase64(fileInput.files[0]);
                    updatedData.photo = newPhotoBase64;
                }

                await update(ref(db, `Vehicles/${currentVehicleKey}`), updatedData);
                alert('Vehicle Updated Successfully!');
                window.location.href = "{% url 'view_vehicle' %}";
            } catch (error) {
                console.error(error);
                alert('Error updating vehicle: ' + error.message);
                btn.innerText = "Save Changes";
                btn.disabled = false;
            }
        });

        // Make preview function global so HTML can access it
        window.previewFile = function() {
            const preview = document.getElementById('currentPhoto');
            const file = document.getElementById('vPhoto').files[0];
            const reader = new FileReader();

            reader.addEventListener("load", function () {
                preview.src = reader.result;
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }
        }
    </script>

</body>
</html>